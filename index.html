<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BOMBSKUY</title>
    <style>
        :root {
            --W: 1000px;
            --H: 600px;
            --brick: #c0392b;
            --brick-dark: #8e2a1f
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: grid;
            place-items: center;
            background: #d6d6d6
        }

        .stage {
            width: var(--W);
            height: var(--H);
            background: #f2f2f2;
            position: relative;
            display: grid;
            place-items: center;
            box-shadow: 0 18px 55px rgba(0, 0, 0, .25);
            overflow: hidden
        }

        .hidden {
            display: none !important
        }

        .card {
            width: 430px;
            text-align: center
        }

        .logo {
            width: min(340px, 90%);
            margin: 0 auto 18px;
            display: block
        }

        .form {
            display: grid;
            gap: 10px
        }

        input,
        select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 4px;
            border: 2px solid var(--brick-dark);
            background: linear-gradient(var(--brick), var(--brick-dark));
            color: #fff;
            outline: none
        }

        input::placeholder {
            color: #ffd7c8
        }

        select {
            appearance: none
        }

        select:focus {
            background: #000;
            color: #fff
        }

        button {
            min-width: 120px;
            padding: 10px 14px;
            border: 0;
            border-radius: 4px;
            background: #000;
            color: #fff;
            cursor: pointer
        }

        button:disabled {
            opacity: .45;
            cursor: not-allowed
        }

        .wide {
            width: 100%;
            margin-top: 6px
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin-top: 6px
        }

        .row button {
            width: 48.5%;
            min-width: 0
        }

        .ov {
            position: absolute;
            inset: 0;
            display: none;
            place-items: center;
            background: rgba(0, 0, 0, .55);
            z-index: 10
        }

        .ov.on {
            display: grid
        }

        .m {
            width: var(--W);
            height: var(--H);
            max-width: 100%;
            max-height: 100%;
            background: rgba(20, 20, 20, .95);
            color: #fff;
            position: relative
        }

        .x {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: #b40000;
            display: grid;
            place-items: center;
            font-weight: 900;
            font-size: 18px;
            cursor: pointer;
            user-select: none
        }

        .pad {
            padding: 90px 160px
        }

        .pad h2 {
            margin: 0 0 14px;
            font-size: 30px;
            text-align: left
        }

        .pad ol {
            margin: 0;
            padding-left: 18px;
            line-height: 1.75;
            text-align: left;
            font-size: 18px
        }

        .count {
            height: 100%;
            display: grid;
            place-items: center;
            font-size: 120px;
            font-weight: 900
        }

        .lb {
            height: 100%;
            display: grid;
            place-items: center;
            padding: 70px 0;
            gap: 24px
        }

        .lb h1 {
            margin: 0;
            font-size: 44px;
            font-weight: 800;
            letter-spacing: .2px
        }

        .grid {
            width: 560px;
            display: grid;
            grid-template-columns: 1.6fr .8fr .3fr .3fr .3fr;
            gap: 8px 16px;
            align-items: center
        }

        .th {
            opacity: .95;
            font-weight: 700
        }

        .icon {
            display: grid;
            place-items: center
        }

        .icon img {
            width: 28px;
            height: 28px;
            image-rendering: pixelated
        }

        .rows {
            grid-column: 1/-1;
            display: grid;
            grid-template-columns: inherit;
            gap: 10px 16px;
            max-height: 220px;
            overflow: auto;
            padding-right: 6px
        }

        .r {
            display: contents
        }

        .cell {
            padding: 6px 0;
            font-weight: 700
        }

        .line {
            grid-column: 1/-1;
            height: 1px;
            background: rgba(255, 255, 255, .25)
        }

        .cell:nth-child(5n+3),
        .cell:nth-child(5n+4),
        .cell:nth-child(5n+5) {
            text-align: center
        }

        .rows::-webkit-scrollbar {
            width: 8px
        }

        .rows::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .25);
            border-radius: 8px
        }

        .lbBtns {
            display: flex;
            gap: 18px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap
        }

        .btn {
            min-width: 170px;
            border-radius: 4px;
            font-weight: 800
        }

        .red {
            background: #c74413
        }

        .blue {
            background: #0b6aa8
        }

        .game {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: stretch;
            background: #fff
        }

        .board {
            --T: 67px;
            width: calc(var(--T)*11);
            height: calc(var(--T)*9);
            flex: 0 0 auto;
            position: relative;
            display: grid;
            grid-template-columns: repeat(11, var(--T));
            grid-template-rows: repeat(9, var(--T));
            background: url("assets/images/background.jpg") no-repeat center/cover;
            image-rendering: pixelated
        }

        .tile {
            width: var(--T);
            height: var(--T);
            background-size: cover;
            image-rendering: pixelated;
            position: absolute
        }

        .brick {
            background-image: url("assets/images/wall.png")
        }

        .entity {
            position: absolute;
            width: calc(var(--T)*.9);
            height: calc(var(--T)*.9);
            image-rendering: pixelated;
            pointer-events: none
        }

        .sprite {
            z-index: 2
        }

        .bomb {
            z-index: 3
        }

        .fx {
            z-index: 5
        }

        .mark {
            width: calc(var(--T)*.42);
            height: calc(var(--T)*.42);
            z-index: 8;
            filter: drop-shadow(0 2px 0 rgba(0, 0, 0, .35))
        }

        .bomb.blink {
            animation: bl .25s infinite alternate
        }

        @keyframes bl {
            to {
                filter: hue-rotate(330deg) saturate(3) brightness(1.2) drop-shadow(0 0 6px #f00)
            }
        }

        .walk {
            animation: wk .12s steps(2) 2
        }

        @keyframes wk {
            50% {
                transform: translateY(-3px)
            }
        }

        .hurt {
            animation: ht .26s steps(2) 1
        }

        @keyframes ht {
            25% {
                transform: translateX(-4px)
            }

            50% {
                transform: translateX(4px)
            }

            75% {
                filter: brightness(1.6) saturate(2) drop-shadow(0 0 8px #f00)
            }
        }

        .iceo {
            opacity: .45
        }

        .hud {
            flex: 1;
            background: #3a3a3a;
            color: #fff;
            padding: 20px 18px
        }

        .hudTitle {
            margin: 0 0 14px;
            font-size: 34px;
            letter-spacing: 1px
        }

        .meta {
            line-height: 1.6;
            margin-bottom: 14px
        }

        .hearts {
            display: flex;
            gap: 8px;
            margin: 10px 0 18px
        }

        .hearts img {
            width: 34px;
            height: 34px;
            image-rendering: pixelated
        }

        .stats {
            display: grid;
            gap: 18px;
            margin-top: 10px
        }

        .stat {
            display: grid;
            grid-template-columns: 56px 20px 1fr;
            align-items: center;
            font-size: 26px;
            font-weight: 800
        }

        .stat img {
            width: 46px;
            height: 46px;
            image-rendering: pixelated
        }

        .stat span {
            display: grid;
            place-items: center;
            opacity: .9
        }

        .stat b {
            justify-self: start
        }

        .go,
        .pause {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center
        }

        .go .c,
        .pause .c {
            display: grid;
            place-items: center;
            text-align: center;
            gap: 14px
        }

        .go h1,
        .pause h1 {
            margin: 0;
            font-size: 54px;
            font-weight: 900
        }

        .go p,
        .pause p {
            margin: 0;
            opacity: .9;
            font-weight: 700
        }

        .pause p {
            font-size: 18px
        }

        .go .sc {
            display: flex;
            gap: 26px;
            align-items: center;
            justify-content: center
        }

        .go .sc img {
            width: 52px;
            height: 52px;
            image-rendering: pixelated
        }

        .go .sc b {
            font-size: 34px
        }

        .go .btns,
        .pause .btns {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap
        }

        .go .btns button {
            min-width: 200px;
            font-weight: 900
        }

        .pause .btns button {
            min-width: 220px;
            font-weight: 900
        }

        .go .btns .s {
            background: #c74413
        }

        .go .btns .l {
            background: #0b6aa8
        }

        @media(max-width:1020px) {
            .stage {
                transform: scale(calc(min(1, (100vw-20px)/1000, (100vh-20px)/600)));
                transform-origin: center
            }
        }
    </style>
</head>

<body>
    <main class="stage">
        <section id="welcome" class="card">
            <img class="logo" src="assets/images/logo.png" alt="BOMBSKUY" />
            <div class="form">
                <input id="name" placeholder="Input Username" autocomplete="off" />
                <select id="level">
                    <option value="" selected disabled>Select Level</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
                <div class="row"><button id="play" disabled>Play</button><button id="instr"
                        type="button">Instruction</button></div>
                <button id="lb" class="wide" type="button">Leaderboard</button>
            </div>
        </section>

        <section id="game" class="game hidden">
            <div id="board" class="board"></div>
            <aside class="hud">
                <h2 class="hudTitle">BOMSKUY</h2>
                <div class="meta">
                    <div><b>Player</b> : <span id="hudName">-</span></div>
                    <div><b>Time</b> : <span id="hudTime">00:00</span></div>
                </div>
                <div id="hearts" class="hearts"></div>
                <div class="stats">
                    <div class="stat"><img src="assets/images/wall_crack.png" alt=""><span>=</span><b id="cWall">0</b>
                    </div>
                    <div class="stat"><img src="assets/images/tnt.png" alt=""><span>=</span><b id="cTnt">0</b></div>
                    <div class="stat"><img src="assets/images/ice.png" alt=""><span>=</span><b id="cIce">0</b></div>
                </div>
            </aside>
        </section>

        <div id="instrOv" class="ov">
            <div class="m">
                <div class="x" data-close>✕</div>
                <div class="pad">
                    <h2>How to play game</h2>
                    <ol>
                        <li>Input Username</li>
                        <li>Put the bomb (Space)</li>
                        <li>Blow up as many walls as possible</li>
                        <li>Avoid the dogs</li>
                        <li>Press ESC to pause</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="lbOv" class="ov">
            <div class="m">
                <div class="x" id="lbClose">✕</div>
                <div class="lb">
                    <h1>Leaderboards</h1>
                    <div class="grid">
                        <div class="th">Player Name</div>
                        <div class="th">Time</div>
                        <div class="th icon"><img src="assets/images/wall_crack.png" alt=""></div>
                        <div class="th icon"><img src="assets/images/tnt.png" alt=""></div>
                        <div class="th icon"><img src="assets/images/ice.png" alt=""></div>
                        <div id="lbRows" class="rows"></div>
                    </div>
                    <div class="lbBtns">
                        <button id="lbHome" class="btn blue">Back to Home</button>
                        <button id="playAgain" class="btn red">Play Again</button>
                        <button id="lbReset" class="btn blue">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cdOv" class="ov">
            <div class="m">
                <div class="count" id="countNum">3</div>
            </div>
        </div>

        <div id="pauseOv" class="ov">
            <div class="m">
                <div class="pause">
                    <div class="c">
                        <h1>Paused</h1>
                        <p>Press <b>ESC</b> again or click <b>Continue</b>.</p>
                        <div class="btns"><button id="btnContinue" class="blue">Continue</button><button id="btnHome"
                                class="red">Back to Home</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="goOv" class="ov">
            <div class="m">
                <div class="go">
                    <div class="c">
                        <h1>Game Over!</h1>
                        <p id="goTxt"></p>
                        <div class="sc">
                            <img src="assets/images/wall_crack.png" alt=""><b id="goW">0</b>
                            <img src="assets/images/tnt.png" alt=""><b id="goB">0</b>
                            <img src="assets/images/ice.png" alt=""><b id="goI">0</b>
                        </div>
                        <div class="btns"><button id="goSave" class="s">Save Score</button><button id="goLB"
                                class="l">Leaderboards</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const $ = id => document.getElementById(id), Q = s => document.querySelector(s);

        // kumpulan elemen ui
        const E = {
            name: $("name"), level: $("level"), play: $("play"), welcome: $("welcome"), game: $("game"), board: $("board"), 
            instrOv: $("instrOv"), lbOv: $("lbOv"), cdOv: $("cdOv"), goOv: $("goOv"), pauseOv: $("pauseOv"),
            countNum: $("countNum"), hudName: $("hudName"), hudTime: $("hudTime"), hearts: $("hearts"),
            cWall: $("cWall"), cTnt: $("cTnt"), cIce: $("cIce"), lbRows: $("lbRows"),
            goTxt: $("goTxt"), goW: $("goW"), goB: $("goB"), goI: $("goI"), goSave: $("goSave"),
            lbHome: $("lbHome"), btnContinue: $("btnContinue"), btnHome: $("btnHome"),
            lbClose: $("lbClose"), playAgain: $("playAgain"), lbReset: $("lbReset")
        };

        // key penyimpanan
        const KEY_LB = "BOMBSKUY_LB", KEY_HIST = "BOMBSKUY_HISTORY";

        // Helper localStorage (get & set JSON)
        const J = { g: k => JSON.parse(localStorage.getItem(k) || "[]"), s: (k, v) => localStorage.setItem(k, JSON.stringify(v)) };

        // Ambil & simpan leaderboard
        const getLB = _ => J.g(KEY_LB), setLB = a => J.s(KEY_LB, a);

        // Ambil & simpan history
        const getHist = _ => J.g(KEY_HIST), setHist = a => J.s(KEY_HIST, a);

        // Buka / tutup overlay
        const open = (o, on) => o.classList.toggle("on", !!on);

        // konfigurasi map ,tinggi,lebar,ukuran tile (px)
        const W = 11, H = 9, T = 67, 
        
        // area aman player
        SAFE = [[1, 1], [2, 1], [3, 1], [1, 2], [1, 3]];
        
        // cek posisi apakah aman
        const inSafe = (x, y) => SAFE.some(p => p[0] == x && p[1] == y);

        // jumlah musuh berdasarkan level
        const dogCount = l => ({ Easy: 1, Medium: 2, Hard: 3 }[l] || 1);

        // state game
        let map = [], brickEl = [], hiddenItem = [], items = [], bombs = [], player, dogs = [],
            tick = 0, ai = 0, hp = 3, freeze = 0, range = 1, wallBroken = 0, tntGot = 0, iceGot = 0, iceOL = 0, inv = 0,
            mark = 0, mt = 0, run = 0, ended = 0, paused = 0, ctx = "home", lastN = "", lastL = "", total = 0;

        // timer (pause-safe)
        let t0 = 0, elapsedMs = 0;
        const tsec = _ => ((elapsedMs + (run && !paused ? Date.now() - t0 : 0)) / 1000 | 0);
        const fmt = s => `${String(s / 60 | 0).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}`;


        const SRC = {
            bomb: "assets/images/bomb.png", exp: "assets/images/explosion.png", heart: "assets/images/heart.png",
            tnt: "assets/images/tnt.png", ice: "assets/images/ice.png", hf: "assets/images/heart_full.png", he: "assets/images/heart_empty.png", wc: "assets/images/wall_crack.png"
        };

        // cek apakah bisa play 
        const canPlay = _ => E.name.value.trim() && E.level.value;

        // Aktif/nonaktif tombol play
        E.name.oninput = _ => E.play.disabled = !canPlay();
        E.level.onchange = _ => { E.level.blur(); E.play.disabled = !canPlay() };

        // Tombol instruction → buka overlay instruksi
        $("instr").onclick = _ => open(E.instrOv, 1);

        // Tombol leaderboard dari HOME
        // set context = home, tampilkan leaderboard, buka overlay LB
        $("lb").onclick = _ => { ctx = "home"; showLB(); open(E.lbOv, 1) };

        // Tombol leaderboard dari GAME OVER
        // context = go, tutup game over, buka leaderboard
        $("goLB").onclick = _ => { ctx = "go"; showLB(); open(E.goOv, 0); open(E.lbOv, 1) };

        // Tombol close leaderboard
        // kalau dari game over → balik ke game over
        // kalau dari home → balik ke home
        E.lbClose.onclick = _ => { open(E.lbOv, 0); ctx == "go" ? open(E.goOv, 1) : home() };

        // Tombol home di leaderboard → kembali ke home
        E.lbHome.onclick = _ => { open(E.lbOv, 0); home() };
        
        // Klik elemen dengan atribut data-close → tutup instruksi
        addEventListener("click", e => e.target.matches("[data-close]") && open(E.instrOv, 0));

        // Membuat sprite (img) di posisi grid (x,y)
        const addSprite = (src, x, y, cls = "sprite") => {
            const img = document.createElement("img");
            img.src = src; img.className = `entity ${cls}`;
            img.style.cssText = `left:${x * T}px;top:${y * T}px`;
            E.board.appendChild(img); return img;
        };

        // Render nyawa (heart penuh / kosong)
        const renderHearts = _ => E.hearts.innerHTML = Array.from({ length: 3 }, (_, i) => `<img src="${i < hp ? SRC.hf : SRC.he}" alt="">`).join("");

        // Animasi kena damage (shake / flash)
        const hitAni = (el, cls) => { el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls); setTimeout(_ => el.classList.remove(cls), 280) };

        // Pasang icon efek (heart / TNT / ice) 
        const setMark = src => {
            // di atas kepala player
            mark && mark.remove(); clearTimeout(mt);
            // Jika ada src → buat mark baru
            mark = src ? addSprite(src, player.x, player.y, "mark") : 0;
            // Posisi mark di atas player
            mark.style.left = player.x * T + T * .38 + "px"; mark.style.top = player.y * T - 2 + "px";
            // Mark hilang otomatis setelah 5 detik
            mt = setTimeout(_ => { mark && mark.remove(); mark = 0 }, 5000);
        };

        // Update posisi mark saat player bergerak
        const updMark = _ => mark && (mark.style.left = player.x * T + T * .38 + "px", mark.style.top = player.y * T - 2 + "px");

        // home/reset game

        function home() {
        // Reset status game
            paused = run = ended = 0;
            // Tutup semua overlay
            [E.pauseOv, E.goOv, E.cdOv, E.instrOv, E.lbOv].forEach(x => open(x, 0));
            // Tampilkan layar welcome
            E.welcome.classList.remove("hidden"); E.game.classList.add("hidden");
            // Hentikan AI dan timer
            clearInterval(ai); clearInterval(tick); ctx = "home";
        }

        // leadernboard

        function showLB() {
            const d = getLB().slice().sort((a, b) => (b.w - a.w) || (b.b - a.b) || (b.i - a.i) || (a.s - b.s));
            E.lbRows.innerHTML = d.length ? d.map((x, i) => `<div class="r">
    <div class="cell">${x.n}</div><div class="cell">${x.t}</div>
    <div class="cell">${x.w}</div><div class="cell">${x.b}</div><div class="cell">${x.i}</div>
    ${i < d.length - 1 ? `<div class="line"></div>` : ""}
  </div>`).join("") : `<div class="cell" style="grid-column:1/-1;opacity:.8">No data</div>`;
            E.playAgain.style.display = E.lbHome.style.display = ctx == "go" ? "" : "none";
        }

        E.lbReset.onclick = _ => confirm("Reset leaderboard?") && (setLB([]), setHist([]), showLB(), alert("Leaderboard berhasil direset!"));
        E.playAgain.onclick = _ => { open(E.lbOv, 0); E.name.value = lastN; E.level.value = lastL; E.play.disabled = 0; startGame(1) };

        function buildStoneMap() {
            map = Array.from({ length: H }, (_, y) => Array.from({ length: W }, (_, x) => ((!x || !y || x == W - 1 || y == H - 1) || (x % 2 == 0 && y % 2 == 0)) ? 1 : 0));
            SAFE.forEach(([x, y]) => map[y][x] = 0);
            brickEl = Array.from({ length: H }, _ => Array(W).fill(0));
            hiddenItem = Array.from({ length: H }, _ => Array(W).fill(0));
            items = []; bombs = []; total = 0;
        }

        function placeRandomBricks(t = 18) {
            for (let p = 0; p < t;) {
                const x = 1 + Math.random() * (W - 2) | 0, y = 1 + Math.random() * (H - 2) | 0;
                if (map[y][x] == 0 && !inSafe(x, y)) {
                    map[y][x] = 2; p++; total++;
                    const r = Math.random();
                    r < .35 && (hiddenItem[y][x] = r < .12 ? "heart" : r < .24 ? "tnt" : "ice");
                }
            }
        }

        function drawBoard() {
            E.board.innerHTML = ""; E.board.style.setProperty("--T", T + "px");
            for (let y = 0; y < H; y++)for (let x = 0; x < W; x++)if (map[y][x] == 2) {
                const d = document.createElement("div");
                d.className = "tile brick";
                d.style.cssText = `left:${x * T}px;top:${y * T}px`;
                E.board.appendChild(d); brickEl[y][x] = d;
            }
        }

        function initHUD() {
            lastN = E.hudName.textContent = E.name.value.trim(); lastL = E.level.value;
            E.hudTime.textContent = "00:00";
            hp = 3; range = 1; freeze = inv = 0; wallBroken = tntGot = iceGot = 0;
            E.cWall.textContent = E.cTnt.textContent = E.cIce.textContent = "0";
            renderHearts();
            mark && mark.remove(); mark = 0; clearTimeout(mt);
            ended = paused = 0; run = 1; elapsedMs = 0; t0 = Date.now();
        }

        const startTimer = _ => { clearInterval(tick); tick = setInterval(_ => E.hudTime.textContent = fmt(tsec()), 250) };
        function spawnPlayer() { player = { x: 1, y: 1, dir: "down", img: addSprite("assets/images/char_down.png", 1, 1) } }

        function randEmptyCell() {
            for (let t = 0; t < 600; t++) {
                const x = 1 + Math.random() * (W - 2) | 0, y = 1 + Math.random() * (H - 2) | 0;
                if (map[y][x] == 0 && !inSafe(x, y)) return { x, y };
            }
            return { x: W - 2, y: H - 2 };
        }

        function spawnDogs(n) {
            dogs = [];
            while (dogs.length < n) {
                const { x, y } = randEmptyCell();
                if (dogs.some(d => d.x == x && d.y == y)) continue;
                (x == 1 && y == 1) || dogs.push({ x, y, img: addSprite("assets/images/dog_down.png", x, y), last: 0 });
            }
        }

        const rebuildAndRender = _ => { buildStoneMap(); placeRandomBricks(); drawBoard(); spawnPlayer(); spawnDogs(dogCount(E.level.value)) };
        const bombAt = (x, y) => bombs.some(b => b.x == x && b.y == y);
        const canWalk = (x, y) => x >= 0 && y >= 0 && x < W && y < H && map[y][x] == 0 && !bombAt(x, y);

        const dmg = (fromEl = 0) => {
            if (Date.now() < inv || !run || paused) return;
            hp = Math.max(0, hp - 1); renderHearts(); inv = Date.now() + 700;
            hitAni(player.img, "hurt"); fromEl && hitAni(fromEl, "hurt");
            hp || finish(0);
        };

        function finish(win) {
            if (ended) return; ended = 1; run = 0;
            if (!paused) elapsedMs += Date.now() - t0;
            paused = 0; clearInterval(ai); clearInterval(tick);
            ctx = "go";
            E.goTxt.textContent = `Player: ${lastN} • Time: ${fmt(tsec())}`;
            E.goW.textContent = wallBroken; E.goB.textContent = tntGot; E.goI.textContent = iceGot;
            E.goSave.disabled = 0; open(E.goOv, 1);
        }

        const touchDog = _ => { const d = dogs.find(d => d.x == player.x && d.y == player.y); d && dmg(d.img) };

        function touchItem() {
            const it = items.find(a => a.x == player.x && a.y == player.y); if (!it) return;
            if (it.t == "heart") { setMark(SRC.heart); dmg(); it.el.remove(); items = items.filter(a => a != it); return }
            if (it.t == "tnt") { range = Math.min(range * 2, 5); E.cTnt.textContent = ++tntGot; setMark(SRC.tnt); it.el.remove(); items = items.filter(a => a != it); return }
            freeze = Date.now() + 5000; E.cIce.textContent = ++iceGot; setMark(SRC.ice);
            player.img.classList.add("iceo"); it.el.style.zIndex = 9; it.el.classList.add("iceo"); iceOL = it.el;
            setTimeout(_ => { player.img.classList.remove("iceo"); iceOL && iceOL.remove(); iceOL = 0; items = items.filter(a => a != it) }, 5000);
        }

        function move(dx, dy, dir) {
            if (!run || paused || Date.now() < freeze) return;
            const nx = player.x + dx, ny = player.y + dy;
            player.dir = dir; player.img.src = `assets/images/char_${dir}.png`; hitAni(player.img, "walk");
            if (canWalk(nx, ny)) {
                player.x = nx; player.y = ny;
                player.img.style.left = nx * T + "px"; player.img.style.top = ny * T + "px";
                updMark(); touchItem(); touchDog();
            }
        }

        function destroyBrick(x, y) {
            if (map[y][x] != 2) return;
            map[y][x] = 0; const el = brickEl[y][x];
            el && (el.style.backgroundImage = `url("${SRC.wc}")`, setTimeout(_ => el.remove(), 220), brickEl[y][x] = 0);
            E.cWall.textContent = ++wallBroken;
            const hi = hiddenItem[y][x]; hiddenItem[y][x] = 0;
            hi && items.push({ t: hi, x, y, el: addSprite(SRC[hi], x, y, "fx") });
            wallBroken >= total && hp > 0 && finish(1);
        }

        function boomCells(x, y) {
            const out = [[x, y]];
            for (const [dx, dy] of [[1, 0], [-1, 0], [0, 1], [0, -1]]) for (let i = 1; i <= range; i++) {
                const nx = x + dx * i, ny = y + dy * i;
                if (map[ny]?.[nx] == null || map[ny][nx] == 1) break;
                out.push([nx, ny]);
                if (map[ny][nx] == 2) { destroyBrick(nx, ny); break }
            }
            return out;
        }

        function explode(b) {
            bombs = bombs.filter(x => x != b); b.el.remove();
            const cells = boomCells(b.x, b.y);
            cells.forEach(([x, y]) => { const fx = addSprite(SRC.exp, x, y, "fx"); setTimeout(_ => fx.remove(), 250) });
            cells.some(([x, y]) => x == player.x && y == player.y) && dmg();
        }

        function placeBomb() {
            if (!run || paused || Date.now() < freeze || bombAt(player.x, player.y)) return;
            const b = { x: player.x, y: player.y, el: addSprite(SRC.bomb, player.x, player.y, "bomb") };
            bombs.push(b);
            setTimeout(_ => b.el.classList.add("blink"), 4000);
            setTimeout(_ => explode(b), 5000);
        }

        function clearLine(x1, y1, x2, y2) {
            if (x1 == x2) { for (let y = Math.min(y1, y2) + 1; y < Math.max(y1, y2); y++)if (map[y][x1]) return 0; return 1 }
            if (y1 == y2) { for (let x = Math.min(x1, x2) + 1; x < Math.max(x1, x2); x++)if (map[y1][x]) return 0; return 1 }
            return 0;
        }

        const dogDir = (dx, dy) => Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? "right" : "left") : (dy > 0 ? "down" : "up");

        function dogStep(d) {
            if (!run || paused) return;
            let nx = d.x, ny = d.y, see = clearLine(d.x, d.y, player.x, player.y);
            if (see) {
                if (d.x == player.x) ny += Math.sign(player.y - d.y); else nx += Math.sign(player.x - d.x);
                canWalk(nx, ny) || (nx = d.x, ny = d.y);
            } else {
                const opts = [[1, 0], [-1, 0], [0, 1], [0, -1]].map(([dx, dy]) => [d.x + dx, d.y + dy, dx, dy]).filter(a => canWalk(a[0], a[1]));
                if (opts.length) {
                    let pick = opts[Math.random() * opts.length | 0];
                    if (opts.length > 1 && d.last && pick[2] == -d.last[0] && pick[3] == -d.last[1])
                        pick = opts.find(o => !(o[2] == -d.last[0] && o[3] == -d.last[1])) || pick;
                    nx = pick[0]; ny = pick[1]; d.last = [pick[2], pick[3]];
                }
            }
            if (nx == d.x && ny == d.y) return;
            d.img.src = `assets/images/dog_${dogDir(nx - d.x, ny - d.y)}.png`;
            d.x = nx; d.y = ny; d.img.style.left = nx * T + "px"; d.img.style.top = ny * T + "px";
            d.x == player.x && d.y == player.y && dmg(d.img);
        }

        const startAI = _ => { clearInterval(ai); ai = setInterval(_ => dogs.forEach(d => dogStep(d)), 700) };

        // pause
        function togglePause(force) {
            if (ended || E.game.classList.contains("hidden")) return;
            const want = typeof force == "boolean" ? force : !paused;
            if (want && run) {
                paused = 1; elapsedMs += Date.now() - t0; clearInterval(tick); clearInterval(ai); open(E.pauseOv, 1);
            } else if (!want && paused) {
                paused = 0; t0 = Date.now(); startTimer(); startAI(); open(E.pauseOv, 0);
            }
        }
        E.btnContinue.onclick = _ => togglePause(0);
        E.btnHome.onclick = _ => home();

        addEventListener("keydown", e => {
            const k = e.key.toLowerCase();
            if (k === "escape") {
                if (E.instrOv.classList.contains("on")) return open(E.instrOv, 0);
                if (E.lbOv.classList.contains("on")) { open(E.lbOv, 0); return ctx == "go" ? open(E.goOv, 1) : home() }
                if (E.goOv.classList.contains("on") || E.cdOv.classList.contains("on")) return;
                return togglePause();
            }
            if (E.game.classList.contains("hidden") || !run || paused) return;
            if (k === " " || k === "spacebar") return placeBomb();
            if (k === "arrowup" || k === "w") return move(0, -1, "up");
            if (k === "arrowdown" || k === "s") return move(0, 1, "down");
            if (k === "arrowleft" || k === "a") return move(-1, 0, "left");
            if (k === "arrowright" || k === "d") return move(1, 0, "right");
        });

        async function startGame() {
            [E.instrOv, E.lbOv, E.goOv, E.pauseOv].forEach(x => open(x, 0));
            E.welcome.classList.add("hidden"); E.game.classList.add("hidden");
            open(E.cdOv, 1);
            for (let n = 3; n >= 1; n--) { E.countNum.textContent = n; await new Promise(r => setTimeout(r, 650)) }
            open(E.cdOv, 0);
            E.game.classList.remove("hidden");
            initHUD(); rebuildAndRender(); startTimer(); startAI();
        }
        E.play.onclick = _ => startGame();

        E.goSave.onclick = _ => {
            if (E.goSave.disabled) return;
            const n = lastN, s = tsec(), t = fmt(s), w = wallBroken, b = tntGot, i = iceGot, cur = { n, t, s, w, b, i, at: Date.now() };
            const hist = getHist(); hist.unshift(cur); setHist(hist.slice(0, 200));
            let d = getLB(), idx = d.findIndex(x => x.n == n);
            if (idx < 0) d.push(cur);
            else {
                const x = d[idx];
                const better = (w > x.w) || (w == x.w && b > x.b) || (w == x.w && b == x.b && i > x.i) || (w == x.w && b == x.b && i == x.i && s < x.s);
                better && (d[idx] = cur);
            }
            d.sort((a, b) => (b.w - a.w) || (b.b - a.b) || (b.i - a.i) || (a.s - b.s));
            setLB(d.slice(0, 50));
            E.goSave.disabled = 1; alert("Score saved!");
        };
    </script>
</body>

</html>